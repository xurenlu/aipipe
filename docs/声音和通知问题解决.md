# 声音和通知问题已解决

## 🎯 问题反馈

1. **osascript 播放声音不行，afplay 可以**
2. **测试命令没有看到通知提示**

## ✅ 解决方案

### 1. 简化声音播放逻辑

**改进前：**
- 尝试多种 osascript 声音名称
- 复杂的多层次尝试逻辑

**改进后：**
- 直接使用 `afplay` 播放系统音频文件（经验证可靠）
- 简化代码，提高可靠性
- 添加详细的 verbose/debug 日志

### 2. 增加调试信息

现在使用 `--verbose` 或 `--debug` 会显示：
- ✅ 通知已发送 / ⚠️ 发送通知失败
- 🔊 播放声音: /System/Library/Sounds/Glass.aiff
- 💡 权限检查提示

### 3. 提供详细的通知权限设置指南

创建了完整的文档：`NOTIFICATION_SETUP.md`

## 🚀 快速设置通知权限

### 方法 1: 使用交互式测试脚本（推荐）

```bash
./test-notification-quick.sh
```

这个脚本会：
1. 自动打开系统通知设置
2. 引导你完成配置
3. 测试通知和声音是否工作
4. 给出明确的结果反馈

### 方法 2: 手动设置

**1. 打开通知设置**
```bash
open "x-apple.systempreferences:com.apple.preference.notifications"
```

**2. 找到「终端」应用**
- 在右侧列表中找到「终端」或「Terminal」

**3. 启用以下选项**
- ✅ **「允许通知」** ← 最重要！必须开启
- 通知样式：选择「横幅」或「提醒」
- ✅ 「在通知中心显示」
- ✅ 「播放通知声音」

## 🧪 测试方法

### 测试 1: 手动测试通知

```bash
osascript -e 'display notification "测试通知" with title "测试"'
```

**预期结果：**
- 应该在屏幕右上角看到通知

### 测试 2: 手动测试声音

```bash
afplay /System/Library/Sounds/Glass.aiff
```

**预期结果：**
- 应该听到清脆的玻璃声

### 测试 3: 测试 SuperTail

```bash
echo '2025-10-13 ERROR Database failed' | ./supertail --format java --verbose
```

**预期结果：**
- 应该看到通知
- 应该听到声音（3 秒后）
- 终端输出重要日志信息

### 测试 4: 运行完整测试脚本

```bash
# 快速交互式测试（推荐）
./test-notification-quick.sh

# 完整自动化测试
./test-notification-sound.sh
```

## 📝 检查清单

在报告问题前，请确认：

- [ ] 已在「系统设置 > 通知 > 终端」中开启「允许通知」
- [ ] 通知样式选择了「横幅」或「提醒」（不是「无」）
- [ ] 系统音量不是静音，且音量 > 30%
- [ ] 没有开启勿扰模式/专注模式
- [ ] 手动测试通知命令可以看到通知
- [ ] 手动测试 afplay 可以听到声音
- [ ] 使用明确的 ERROR 日志测试

## 🔍 常见问题

### Q: 设置正确但还是看不到通知？

尝试：
1. 重启终端应用
2. 重启通知中心：`killall NotificationCenter`
3. 检查是否开启了勿扰模式
4. 查看详细文档：`cat NOTIFICATION_SETUP.md`

### Q: 看到通知但听不到声音？

检查：
1. 系统音量：`osascript -e "output volume of (get volume settings)"`
2. 手动播放测试：`afplay /System/Library/Sounds/Glass.aiff`
3. 音频输出设备是否正确

### Q: verbose 模式没有显示通知相关日志？

说明：
- 通知和声音是异步执行的（goroutine）
- 可能在主程序结束前还没输出
- 这是正常的，不影响功能

解决方法：
- 使用文件监控模式：`./supertail -f logfile.log --format java --verbose`
- 或使用持续的输入流

### Q: 在哪里可以看到通知权限选项？

路径：
- macOS Ventura+: **系统设置 > 通知 > 终端**
- macOS Monterey: **系统偏好设置 > 通知与专注模式 > 终端**
- macOS Big Sur: **系统偏好设置 > 通知 > 终端**

## 📚 相关文档

- **`NOTIFICATION_SETUP.md`** ⭐ - 详细的通知权限设置指南
- **`NOTIFICATION_SOUND_GUIDE.md`** - 声音播放机制说明
- **`test-notification-quick.sh`** ⭐ - 快速交互式测试脚本
- **`test-notification-sound.sh`** - 完整自动化测试脚本
- **`README_supertail.md`** - 主要使用文档

## 💡 核心改进总结

1. **简化声音播放**：直接使用 afplay（可靠）
2. **增加调试信息**：verbose/debug 模式显示详细日志
3. **完善文档**：提供详细的设置指南
4. **交互式测试**：提供脚本引导用户完成设置
5. **问题诊断**：完整的检查清单和故障排查

## 🎉 现在开始使用

```bash
# 1. 运行测试脚本设置权限
./test-notification-quick.sh

# 2. 开始监控日志
tail -f /var/log/app.log | ./supertail --format java

# 或使用文件监控模式
./supertail -f /var/log/app.log --format java

# 3. 触发一个错误测试
echo '2025-10-13 ERROR Test' | ./supertail --format java
```

---

**更新日期**: 2025-10-13  
**状态**: ✅ 已解决  
**关键改进**: 使用 afplay 代替 osascript 播放声音

