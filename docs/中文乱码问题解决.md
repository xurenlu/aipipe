# 中文通知乱码问题已解决

## 🎯 问题描述

用户反馈：
- ✅ 终端显示正常：`⚠️ [重要] 结合材料,运用"正确发挥主观能动性"的知识...`
- ❌ 系统通知显示乱码：无法正确显示中文字符

## 🔍 问题原因

### 根本原因：字符编码问题

当使用 `osascript -e` 直接传递包含中文的字符串时，可能会出现编码问题：

```go
// 问题代码（改进前）
cmd := exec.Command("osascript", "-e", script)
```

AppleScript 在处理 UTF-8 中文字符时，通过 `-e` 参数传递可能会导致编码混乱。

## ✅ 解决方案

### 改进措施

#### 1. 使用标准输入方式

将 AppleScript 脚本通过标准输入传递，而不是命令行参数：

```go
// 改进后的代码
cmd := exec.Command("osascript", "-")
cmd.Stdin = strings.NewReader(script)
```

**优势：**
- 标准输入更好地保持 UTF-8 编码
- 避免命令行参数的转义和编码问题
- 更可靠地处理特殊字符

#### 2. 设置 UTF-8 环境变量

确保 osascript 使用 UTF-8 编码：

```go
cmd.Env = append(os.Environ(), "LANG=zh_CN.UTF-8")
```

**作用：**
- 明确指定使用 UTF-8 字符集
- 支持中文简体（zh_CN）
- 继承父进程的其他环境变量

### 完整的改进代码

```go
func sendNotification(summary, logLine string) {
    // ... 准备内容 ...
    
    // 使用标准输入发送通知
    cmd := exec.Command("osascript", "-")
    cmd.Stdin = strings.NewReader(script)
    cmd.Env = append(os.Environ(), "LANG=zh_CN.UTF-8")
    
    err := cmd.Run()
    // ... 错误处理 ...
}
```

## 🧪 测试验证

### 快速测试

```bash
# 测试中文通知
./test-chinese-notification.sh
```

### 手动测试

#### 测试 1: osascript 中文（方法对比）

```bash
# 方法 A: 使用 -e 参数（可能有问题）
osascript -e 'display notification "数据库连接失败" with title "测试" subtitle "中文摘要"'

# 方法 B: 使用标准输入（推荐）
echo 'display notification "数据库连接失败" with title "测试" subtitle "中文摘要"' | LANG=zh_CN.UTF-8 osascript -
```

#### 测试 2: SuperTail 中文日志

```bash
# 测试包含中文的错误日志
echo '2025-10-13 ERROR 数据库连接失败：超时' | ./supertail --format java

echo '2025-10-13 ERROR 用户认证失败：密码错误' | ./supertail --format java

echo '2025-10-13 ERROR 文件读取失败：权限不足' | ./supertail --format java
```

### 预期结果

**通知应该正确显示：**
- **标题**：⚠️ 重要日志告警
- **副标题（摘要）**：数据库连接失败 / 用户认证失败 / 文件读取失败
- **内容（日志）**：完整的中文日志内容

## 📝 常见中文编码问题

### 问题 1: 终端编码设置

**症状：** 不仅通知乱码，终端也显示乱码

**解决方法：**
```bash
# 检查当前编码
locale

# 设置为 UTF-8
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# 永久设置（添加到 ~/.zshrc 或 ~/.bash_profile）
echo 'export LANG=zh_CN.UTF-8' >> ~/.zshrc
echo 'export LC_ALL=zh_CN.UTF-8' >> ~/.zshrc
```

### 问题 2: Go 程序的字符串处理

**Go 语言默认使用 UTF-8**，所以字符串本身不是问题。问题在于如何传递给外部命令。

**正确做法：**
- ✅ 使用标准输入（stdin）
- ✅ 设置正确的环境变量
- ❌ 避免通过命令行参数传递大量中文

### 问题 3: AppleScript 的字符编码

AppleScript 默认支持 UTF-8，但通过不同方式调用可能有差异：

| 调用方式 | 中文支持 | 推荐度 |
|---------|---------|--------|
| `osascript -e "..."` | ⚠️ 可能有问题 | ❌ |
| `osascript -` (stdin) | ✅ 良好 | ✅ |
| `osascript script.scpt` | ✅ 良好 | ✅ |

## 🔧 完整的改进列表

### 代码改进
1. ✅ 使用 `osascript -` 替代 `osascript -e`
2. ✅ 设置 `LANG=zh_CN.UTF-8` 环境变量
3. ✅ 保持 `escapeForAppleScript` 函数（只转义特殊字符）

### 测试改进
1. ✅ 创建 `test-chinese-notification.sh` 测试脚本
2. ✅ 包含多个中文测试用例
3. ✅ 测试长中文内容截断

### 文档改进
1. ✅ 创建本说明文档
2. ✅ 更新主文档中的说明

## 🎬 使用示例

### 示例 1: 监控包含中文的日志

```bash
# 创建测试日志
cat > test-chinese.log << 'EOF'
2025-10-13 10:00:00 INFO 应用启动成功
2025-10-13 10:00:01 INFO 用户登录：张三
2025-10-13 10:00:02 ERROR 数据库连接失败：连接超时
2025-10-13 10:00:03 ERROR 文件读取错误：权限不足
2025-10-13 10:00:04 WARN 内存使用率过高：85%
EOF

# 监控日志
cat test-chinese.log | ./supertail --format java
```

### 示例 2: 实时监控中文日志

```bash
# 监控包含中文的实时日志
tail -f /var/log/app-chinese.log | ./supertail --format java

# 或使用文件监控模式
./supertail -f /var/log/app-chinese.log --format java
```

### 示例 3: 测试各种中文内容

```bash
# 短中文
echo '2025-10-13 ERROR 失败' | ./supertail --format java

# 中等长度中文
echo '2025-10-13 ERROR 数据库连接失败：超时' | ./supertail --format java

# 长中文（会被截断）
echo '2025-10-13 ERROR 这是一条非常长的中文错误日志消息，包含了很多详细的错误信息和上下文，用于测试系统通知如何处理超长的中文内容' | ./supertail --format java
```

## 📚 技术说明

### UTF-8 编码在 Go 中

Go 语言的字符串是 UTF-8 编码的字节序列：

```go
s := "数据库连接失败"
// s 是 UTF-8 编码的字节序列
// len(s) 返回字节数，不是字符数
```

### 为什么标准输入更好

**使用 `-e` 参数：**
```bash
osascript -e 'display notification "中文"'
# 字符串通过 shell 解析 → 传递给 osascript
# 可能经历多次编码转换
```

**使用标准输入：**
```bash
echo 'display notification "中文"' | osascript -
# 字符串直接通过管道传输
# 保持原始 UTF-8 编码
```

## 💡 最佳实践

### 1. 在代码中

```go
// ✅ 推荐：使用标准输入
cmd := exec.Command("osascript", "-")
cmd.Stdin = strings.NewReader(script)
cmd.Env = append(os.Environ(), "LANG=zh_CN.UTF-8")

// ❌ 不推荐：使用 -e 参数传递中文
cmd := exec.Command("osascript", "-e", script)
```

### 2. 在终端中

```bash
# ✅ 确保终端使用 UTF-8
export LANG=zh_CN.UTF-8

# ✅ 测试编码是否正确
echo "测试中文" | cat

# ✅ 验证环境变量
locale
```

### 3. 在测试中

```bash
# ✅ 使用真实的中文测试用例
./test-chinese-notification.sh

# ✅ 测试不同长度的中文
echo '短' | ./supertail --format java
echo '中等长度的中文内容' | ./supertail --format java
echo '很长很长的中文内容...' | ./supertail --format java
```

## ✅ 验证清单

在报告中文显示问题前，请确认：

- [ ] 终端环境变量设置正确：`echo $LANG` 应该是 `zh_CN.UTF-8`
- [ ] 终端字体支持中文显示
- [ ] 手动测试 osascript 可以显示中文：
  ```bash
  echo 'display notification "测试" with title "中文"' | osascript -
  ```
- [ ] SuperTail 已重新编译（包含最新的中文修复）
- [ ] 运行中文测试脚本：`./test-chinese-notification.sh`

## 🔍 Debug 方法

如果还有中文乱码问题：

### 1. 检查编码环境

```bash
# 查看所有 locale 设置
locale

# 应该看到类似：
# LANG="zh_CN.UTF-8"
# LC_CTYPE="zh_CN.UTF-8"
# LC_ALL="zh_CN.UTF-8"
```

### 2. 测试 osascript 直接调用

```bash
# 测试方法 A
osascript -e 'display notification "测试中文" with title "标题"'

# 测试方法 B
echo 'display notification "测试中文" with title "标题"' | osascript -

# 比较两种方法的显示效果
```

### 3. 查看 SuperTail 详细输出

```bash
# 使用 verbose 模式
echo '2025-10-13 ERROR 测试中文' | ./supertail --format java --verbose

# 使用 debug 模式查看 API 返回
echo '2025-10-13 ERROR 测试中文' | ./supertail --format java --debug
```

### 4. 检查 Go 程序的字符串

```bash
# 在 debug 输出中检查字符串是否正确
# 摘要和日志内容应该是正确的 UTF-8
```

## 📞 还是有问题？

如果按照以上步骤仍然有乱码，请提供：

1. **终端 locale 设置：**
   ```bash
   locale
   ```

2. **测试 osascript 的结果：**
   ```bash
   echo 'display notification "测试" with title "中文"' | osascript -
   ```

3. **SuperTail 的输出：**
   ```bash
   echo '2025-10-13 ERROR 测试' | ./supertail --format java --verbose
   ```

4. **截图：**
   - 终端显示的内容
   - 系统通知显示的内容（对比）

---

**更新日期**: 2025-10-13  
**状态**: ✅ 已解决  
**关键改进**: 使用 osascript stdin 方式 + UTF-8 环境变量

